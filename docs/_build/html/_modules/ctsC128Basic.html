
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ctsC128Basic &#8212; ChiptuneSAK 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ctsC128Basic</h1><div class="highlight"><pre>
<span></span><span class="c1"># Lower MChirp to C128 BASIC PLAY commands</span>
<span class="c1"># returns ascii representation of the program</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">ctsConstants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctsBase</span> <span class="kn">import</span> <span class="n">Rest</span><span class="p">,</span> <span class="n">decompose_duration</span><span class="p">,</span> <span class="n">note_name_to_pitch</span>
<span class="kn">from</span> <span class="nn">ctsChirp</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">ctsErrors</span> <span class="kn">import</span> <span class="n">ChiptuneSAKValueError</span><span class="p">,</span> <span class="n">ChiptuneSAKContentError</span>

<span class="n">WHOLE_NOTE</span> <span class="o">=</span> <span class="mi">1152</span>  <span class="c1"># counter found in the PLAY routines in the BASIC ROM</span>

<span class="c1"># Note: waveform (WF) is a little different in the BASIC, it&#39;s</span>
<span class="c1">#    0=triangle, 1=sawtooth, 2=pulse, 3=noise, and 4=ring modulation</span>
<span class="n">C128_INSTRUMENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;piano&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="c1"># ADSR 0,9,0,0, WF 2, PW 1536</span>
    <span class="s1">&#39;accordion&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>     <span class="c1"># ADSR 12,0,12,0, WF 1 </span>
    <span class="s1">&#39;calliope&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>      <span class="c1"># ADSR 0,0,15,0, WF 0</span>
    <span class="s1">&#39;drum&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>          <span class="c1"># ADSR 0,5,5,0, WF 3</span>
    <span class="s1">&#39;flute&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>         <span class="c1"># ADSR 9,4,4,0, WF 0</span>
    <span class="s1">&#39;guitar&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>        <span class="c1"># ADSR 0,9,2,1, WF 1</span>
    <span class="s1">&#39;harpsichord&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>   <span class="c1"># ADSR 0,9,0,0, WF 2, PW 512</span>
    <span class="s1">&#39;organ&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>         <span class="c1"># ADSR 0,9,9,0, WF 2, PW 2048</span>
    <span class="s1">&#39;trumpet&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>       <span class="c1"># ADSR 8,9,4,1, WF 2, PW 512</span>
    <span class="s1">&#39;xylophone&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>     <span class="c1"># ADSR 0,9,0,0, WF 0</span>
<span class="p">}</span>

<span class="c1"># These types are similar to standard notes and rests but with voice added</span>
<span class="n">BasicNote</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BasicNote&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;note_num&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">])</span>
<span class="n">BasicRest</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BasicRest&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">])</span>

<span class="c1"># These appear to be the only allowed note durations for C128 BASIC</span>
<span class="n">basic_durations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Fraction</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;w.&quot;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
    <span class="n">Fraction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;h.&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
    <span class="n">Fraction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;q.&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
    <span class="n">Fraction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s1">&#39;i.&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span>
    <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s1">&#39;s&#39;</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">sort_order</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort function for measure contents.</span>
<span class="sd">    Items are sorted by time and then, for equal times, by duration (decreasing) and voice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">BasicNote</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">voice</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">BasicRest</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">voice</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">basic_pitch_to_note_name</span><span class="p">(</span><span class="n">note_num</span><span class="p">,</span> <span class="n">octave_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets note name for a given MIDI pitch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">note_num</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ChiptuneSAKValueError</span><span class="p">(</span><span class="s2">&quot;Illegal note number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">note_num</span><span class="p">)</span>
    <span class="n">octave</span> <span class="o">=</span> <span class="p">(</span><span class="n">note_num</span> <span class="o">//</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">octave_offset</span>
    <span class="n">octave</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">octave</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">octave</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">octave</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">note_num</span> <span class="o">%</span> <span class="mi">12</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PITCHES</span><span class="p">[</span><span class="n">pitch</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">octave</span><span class="p">)</span>  <span class="c1"># Accidentals come BEFORE note name so reverse standard</span>


<span class="k">def</span> <span class="nf">basic_duration_to_name</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">ppq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a note duration name for a given duration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="n">ppq</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basic_durations</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ChiptuneSAKValueError</span><span class="p">(</span><span class="s2">&quot;Illegal note duration </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">basic_durations</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">trim_note_lengths</span><span class="p">(</span><span class="n">song</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trims the note lengths in a ChirpSong to only those allowed in C128 Basic</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i_t</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">song</span><span class="o">.</span><span class="n">tracks</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i_n</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">notes</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basic_durations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">basic_durations</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="p">:</span>
                        <span class="n">n</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span>
                        <span class="k">break</span>
                <span class="n">song</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="n">i_n</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>  <span class="c1"># Trim the note in place</span>


<span class="k">def</span> <span class="nf">measures_to_basic</span><span class="p">(</span><span class="n">mchirp_song</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an MChirpSong to C128 Basic command strings.</span>
<span class="sd">    :param mchirp_song:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_measures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mchirp_song</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">measures</span><span class="p">)</span>  <span class="c1"># in mchirp, all tracks have the same number of measures.</span>
    <span class="n">last_voice</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_octave</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
    <span class="n">last_duration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ppq</span> <span class="o">=</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_measures</span><span class="p">):</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Combine events from all three voices into a single list corresponding to the measure</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mchirp_song</span><span class="o">.</span><span class="n">tracks</span><span class="p">))):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">measures</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="c1"># If the voice doesn&#39;t have any notes in the measure, just ignore it.</span>
            <span class="n">note_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Note</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Extract the notes and rests and put them into a list.</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Note</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">tied_to</span><span class="p">:</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decompose_duration</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">basic_durations</span><span class="p">):</span>
                            <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicNote</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">note_num</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">start_time</span> <span class="o">+=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decompose_duration</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">basic_durations</span><span class="p">):</span>
                            <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicRest</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">start_time</span> <span class="o">+=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Rest</span><span class="p">):</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">start_time</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decompose_duration</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">basic_durations</span><span class="p">):</span>
                        <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicRest</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">start_time</span> <span class="o">+=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ppq</span>

        <span class="c1"># Use the sort order to sort all the events in the measure</span>
        <span class="n">contents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_order</span><span class="p">)</span>
        <span class="n">measure_commands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Last voice gets reset at the start of each measure.</span>
        <span class="n">last_voice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="c1">#  We only care about notes and rests.  For now.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">BasicNote</span><span class="p">):</span>
                <span class="n">d_name</span> <span class="o">=</span> <span class="n">basic_duration_to_name</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span><span class="p">)</span>
                <span class="n">note_name</span><span class="p">,</span> <span class="n">octave</span> <span class="o">=</span> <span class="n">basic_pitch_to_note_name</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">note_num</span><span class="p">)</span>
                <span class="n">current_command</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Build the command for this note</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span> <span class="o">!=</span> <span class="n">last_voice</span><span class="p">:</span>
                    <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; v</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">octave</span> <span class="o">!=</span> <span class="n">last_octave</span><span class="p">:</span>
                    <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;o</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">octave</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">duration</span> <span class="o">!=</span> <span class="n">last_duration</span><span class="p">:</span>
                    <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_name</span><span class="p">)</span>
                <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="n">measure_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_command</span><span class="p">))</span>
                <span class="c1"># Set all the state variables</span>
                <span class="n">last_voice</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span>
                <span class="n">last_octave</span> <span class="o">=</span> <span class="n">octave</span>
                <span class="n">last_duration</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">duration</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">BasicRest</span><span class="p">):</span>
                <span class="n">d_name</span> <span class="o">=</span> <span class="n">basic_duration_to_name</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span><span class="p">)</span>
                <span class="n">current_command</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span> <span class="o">!=</span> <span class="n">last_voice</span><span class="p">:</span>
                    <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; v</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">duration</span> <span class="o">!=</span> <span class="n">last_duration</span><span class="p">:</span>
                    <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_name</span><span class="p">)</span>
                <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">measure_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_command</span><span class="p">))</span>
                <span class="c1"># Set the state variables</span>
                <span class="n">last_voice</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">voice</span>
                <span class="n">last_duration</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">duration</span>

        <span class="n">finished_basic_line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">measure_commands</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finished_basic_line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>


<div class="viewcode-block" id="export_midi_to_C128_BASIC"><a class="viewcode-back" href="../utilities.html#ctsC128Basic.export_midi_to_C128_BASIC">[docs]</a><span class="k">def</span> <span class="nf">export_midi_to_C128_BASIC</span><span class="p">(</span><span class="n">mchirp_song</span><span class="p">,</span> <span class="n">instrum</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;piano&#39;</span><span class="p">,</span> <span class="s1">&#39;piano&#39;</span><span class="p">,</span> <span class="s1">&#39;piano&#39;</span><span class="p">),</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;NTSC-C64&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert mchirp into a C128 Basic program that plays the song.</span>

<span class="sd">    :param mchirp_song: An mchirp song</span>
<span class="sd">    :type mchirp_song: MChirpSong</span>
<span class="sd">    :param instrum: tuple of instrument string names, defaults to (&#39;piano&#39;, &#39;piano&#39;, &#39;piano&#39;)</span>
<span class="sd">    :type instrum: tuple, optional</span>
<span class="sd">    :param arch: Commodore architecture, defaults to &#39;NTSC-C64&#39;</span>
<span class="sd">    :type arch: str, optional</span>
<span class="sd">    :raises ChiptuneSAKContentError: Various content errors</span>
<span class="sd">    :raises ChiptuneSAKValueError: Various value errors</span>
<span class="sd">    :return: Returns a binary BASIC file</span>
<span class="sd">    :rtype: bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basic_strings</span> <span class="o">=</span> <span class="n">measures_to_basic</span><span class="p">(</span><span class="n">mchirp_song</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_line</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> rem </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">10</span>
    <span class="c1"># Tempo 1 is slowest, and 255 is fastest</span>
    <span class="n">tempo</span> <span class="o">=</span> <span class="n">mchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">qpm</span> <span class="o">*</span> <span class="n">WHOLE_NOTE</span> <span class="o">/</span> <span class="n">ARCH</span><span class="p">[</span><span class="n">arch</span><span class="p">]</span><span class="o">.</span><span class="n">frame_rate</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">tempo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tempo</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> tempo </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="n">tempo</span><span class="p">))</span>

    <span class="n">current_line</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">measure_num</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basic_strings</span><span class="p">):</span>
        <span class="n">tmp_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">$=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="n">num_to_str_name</span><span class="p">(</span><span class="n">measure_num</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">BASIC_LINE_MAX_C128</span><span class="p">:</span>
            <span class="c1"># it&#39;s ok if space removed between line number and first character</span>
            <span class="n">tmp_line</span> <span class="o">=</span> <span class="n">tmp_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># If the line is still too long...</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">BASIC_LINE_MAX_C128</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChiptuneSAKContentError</span><span class="p">(</span>
                    <span class="s2">&quot;C128 BASIC line too long: Line </span><span class="si">%d</span><span class="s2"> length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_line</span><span class="p">)))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_line</span><span class="p">)</span>

        <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="c1"># Here&#39;s the envelope commands that would have created the set of defaults:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">             n,  A,  D,  S,  R, wf,  pw      instrument</span>

<span class="sd">    ENVELOPE 0,  0,  9,  0,  0,  2,  1536    piano</span>
<span class="sd">    ENVELOPE 1,  12, 0,  12, 0,  1           accordion</span>
<span class="sd">    ENVELOPE 2,  0,  0,  15, 0,  0           calliope</span>
<span class="sd">    ENVELOPE 3,  0,  5,  5,  0,  3           drum</span>
<span class="sd">    ENVELOPE 4,  9,  4,  4,  0,  0           flute</span>
<span class="sd">    ENVELOPE 5,  0,  9,  2,  1,  1           guitar</span>
<span class="sd">    ENVELOPE 6,  0,  9,  0,  0,  2,  512     harpsichord</span>
<span class="sd">    ENVELOPE 7,  0,  9,  9,  0,  2,  2048    organ</span>
<span class="sd">    ENVELOPE 8,  8,  9,  4,  1,  2,  512     trumpet</span>
<span class="sd">    ENVELOPE 9,  0,  9,  0,  0,  0           xylophone    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_line</span> <span class="o">=</span> <span class="mi">7000</span>  <span class="c1"># data might reach line 6740</span>
    <span class="c1"># Note: U9 = volume 15</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="c1"># FUTURE: For each voice, provide a way to pick (or override) the default envelopes</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="s1">&#39;u</span><span class="si">%d</span><span class="s1">v1t</span><span class="si">%d</span><span class="s1">v2t</span><span class="si">%d</span><span class="s1">v3t</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">C128_INSTRUMENTS</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instrum</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> play&quot;</span><span class="si">%s</span><span class="s1">&quot;:rem init instruments&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="n">instruments</span><span class="p">))</span>
    <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="c1"># Command likely out of scope:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FILTER [freq] [,lp] [,bp] [,hp] [,res]</span>
<span class="sd">       &quot;Xn&quot; in PLAY: Filter on (n=1), off (n=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the PLAY lines at the end (like an orderlist for string patterns)</span>
    <span class="c1"># TODO: Can later repeat a measure by PLAYing its string more than once to</span>
    <span class="c1"># achieve measure-level compression</span>
    <span class="n">PLAYS_PER_LINE</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">line_buf</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">measure_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basic_strings</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">measure_num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">measure_num</span> <span class="o">%</span> <span class="n">PLAYS_PER_LINE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_buf</span><span class="p">)))</span>
            <span class="n">line_buf</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="n">line_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;play </span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_to_str_name</span><span class="p">(</span><span class="n">measure_num</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_line</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_buf</span><span class="p">)))</span>
        <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="c1"># debug = &#39;\n&#39;.join(line.encode(&#39;ascii&#39;).decode(&#39;petscii-c64en-lc&#39;) for line in result)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<span class="c1"># Convert measure number to a BASIC string name</span>
<span class="k">def</span> <span class="nf">num_to_str_name</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">675</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ChiptuneSAKValueError</span><span class="p">(</span><span class="s2">&quot;number to convert to str var name out of range&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">upper</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">str_name</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">num</span> <span class="o">//</span> <span class="mi">26</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">((</span><span class="n">num</span> <span class="o">%</span> <span class="mi">26</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">str_name</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ChiptuneSAK</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MusicConcepts.html">Musical Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html">Chirp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html#chirp-formats">Chirp Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html#concepts-in-chirp-music-representation">Concepts in chirp music representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sheetmusic.html">PDF Sheetmusic via Lilypond</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c128BASIC.html">C128 BASIC music programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Classes.html">Classes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, David Youd and David Knapp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>