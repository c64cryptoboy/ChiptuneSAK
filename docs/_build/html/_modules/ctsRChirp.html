
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ctsRChirp &#8212; ChiptuneSAK 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ctsRChirp</h1><div class="highlight"><pre>
<span></span><span class="c1"># cstRChirp.py</span>
<span class="c1">#</span>
<span class="c1"># RChirp is a row-based verison of chirp, useful for export from and to trackers,</span>
<span class="c1"># and other jiffy-based music players.</span>
<span class="c1"># Rows can be constructed and accessed in both sparse (dictionary-like) and contiguous (list-like) forms. </span>
<span class="c1">#</span>
<span class="c1"># TODO:</span>
<span class="c1"># - create proper docstrings on class defs (methods already done)</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">ctsChirp</span>
<span class="kn">from</span> <span class="nn">ctsBase</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctsConstants</span> <span class="kn">import</span> <span class="n">DEFAULT_MIDI_PPQN</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>


<div class="viewcode-block" id="RChirpRow"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpRow">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RChirpRow</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The basic RChirp row</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>           <span class="c1">#: rchirp row number</span>
    <span class="n">jiffy_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1">#: jiffy num since time 0</span>
    <span class="n">note_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>          <span class="c1">#: MIDI note number; None means no note asserted</span>
    <span class="n">instr_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1">#: Instrument number</span>
    <span class="n">new_instrument</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1">#: Instrument number; None means no change</span>
    <span class="n">gate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>             <span class="c1">#: Gate on/off tri-value True/False/None; None means no gate change</span>
    <span class="n">jiffy_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1">#: Jiffies to process this row (until next row)</span>
    <span class="n">new_jiffy_tempo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1">#: New tempo for channel (not global); None means no change</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_num</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">row_num</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">jiffy_num</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">jiffy_len</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">note_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">note_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">note_num</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">note_num</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">gate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instr_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">instr_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instr_num</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">instr_num</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">new_instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instrument</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">new_instrument</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_jiffy_tempo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">new_jiffy_tempo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># only check if both</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_jiffy_tempo</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">new_jiffy_tempo</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RChirpOrderEntry</span><span class="p">:</span>
    <span class="n">pattern_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">transposition</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">repeats</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">RChirpOrderList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An order list made up of a set of patterns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RChirpPattern</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pattern made up of a set of rows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>                  <span class="c1">#: List of RChirpRow instances (NOT a dictionary!m No gaps allowed!)</span>

        <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_row</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">row_num</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>      <span class="c1"># Starting row frame number</span>
            <span class="n">base_jiffy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>  <span class="c1"># Starting jiffy number</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">row_num</span> <span class="o">-=</span> <span class="n">base_row</span>
                <span class="n">r</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">-=</span> <span class="n">base_jiffy</span>
                <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Illegal jiffy number&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort the rows by the row number member.</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>


<div class="viewcode-block" id="RChirpVoice"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpVoice">[docs]</a><span class="k">class</span> <span class="nc">RChirpVoice</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The representation of a single voice; contains rows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rchirp_song</span><span class="p">,</span> <span class="n">chirp_track</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span> <span class="o">=</span> <span class="n">rchirp_song</span>                  <span class="c1">#: The song this voice belongs to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">RChirpRow</span><span class="p">)</span>  <span class="c1">#: dictionary: K:row num, V: RChirpRow instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderlist</span> <span class="o">=</span> <span class="n">RChirpOrderList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">chirp_track</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">chirp_track</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="s2">&quot;&lt;class &#39;ctsChirp.ChirpTrack&#39;&gt;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChiptuneSAKTypeError</span><span class="p">(</span><span class="s2">&quot;MChirpTrack init can only import ChirpTrack objects.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_chirp_track</span><span class="p">(</span><span class="n">chirp_track</span><span class="p">)</span>     

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jiffy_indexed_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns dictionary of rows indexed by jiffy number</span>

<span class="sd">        A voice holds onto a dictionary of rows keyed by row number.  This method returns</span>
<span class="sd">        a dictionary of rows keyed by jiffy number. </span>

<span class="sd">        :return: A dictionary of rows keyed by jiffy number</span>
<span class="sd">        :rtype: defaultdict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_val</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">jiffy_num</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">return_val</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">RChirpRow</span><span class="p">,</span> <span class="n">return_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sorted_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of row-number sorted rows for the voice</span>

<span class="sd">        :return: A sorted list of RChirpRow instances</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

<div class="viewcode-block" id="RChirpVoice.append_row"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpVoice.append_row">[docs]</a>    <span class="k">def</span> <span class="nf">append_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rchirp_row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a row to the voice&#39;s collection of rows</span>

<span class="sd">        This is a helper method for treating rchirp like a list of contiguous rows,</span>
<span class="sd">        instead of a sparse dictionary of rows</span>
<span class="sd">        </span>
<span class="sd">        :param rchirp_row: A row to &quot;append&quot;</span>
<span class="sd">        :type rchirp_row: RChirpRow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">insert_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rchirp_row</span><span class="p">)</span>
        <span class="n">insert_row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_row_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">insert_row</span><span class="o">.</span><span class="n">row_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">insert_row</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the row with the largest jiffy number (latest in time)</span>

<span class="sd">        :return: row with latest jiffy number</span>
<span class="sd">        :rtype: RChirpRow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">get</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_row_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns one greater than the largest row number held onto by the voice</span>

<span class="sd">        :return: largest row number + 1</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="RChirpVoice.is_contiguous"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpVoice.is_contiguous">[docs]</a>    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the voice&#39;s rows are contiguous.  This function requires that row numbers</span>
<span class="sd">        are consecutive and that the corresponding jiffy numbers have no gaps.</span>
<span class="sd">        </span>
<span class="sd">        :return: True if rows are contiguous, False if not</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_row</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">curr_jiffy</span><span class="p">,</span> <span class="n">curr_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">start_row</span><span class="p">]</span><span class="o">.</span><span class="n">jiffy_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">start_row</span><span class="p">]</span><span class="o">.</span><span class="n">row_num</span>
        <span class="k">for</span> <span class="n">row_num</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">row_num</span><span class="p">]</span><span class="o">.</span><span class="n">row_num</span> <span class="o">!=</span> <span class="n">curr_row</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">row_num</span><span class="p">]</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">!=</span> <span class="n">curr_jiffy</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">curr_row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">curr_jiffy</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">row_num</span><span class="p">]</span><span class="o">.</span><span class="n">jiffy_len</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RChirpVoice.integrity_check"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpVoice.integrity_check">[docs]</a>    <span class="k">def</span> <span class="nf">integrity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds problems with a voice&#39;s row data</span>

<span class="sd">        :return: True if all integrity checks pass</span>
<span class="sd">        :raises AssertionError: Various integrity failure assertions possible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jiffy_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">row_num</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpVoice has a row number that doesn&#39;t match its row number index&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">row_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have row_num = None&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have a negative row_num&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have jiffy_num = None&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have a negative jiffy_num&quot;</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">note_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">note_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have a negative note_num&quot;</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">new_instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
                <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">new_instrument</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have a negative instrument&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have jiffy_len = None&quot;</span>
            <span class="k">assert</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Error: RChirpRow row cannot have a negative jiffy_len&quot;</span>
            <span class="n">row_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">row_num</span><span class="p">)</span>
            <span class="n">jiffy_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">jiffy_num</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_nums</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row_nums</span><span class="p">)),</span> <span class="s2">&quot;Error: RChirpVoice row numbers must be unique&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">jiffy_nums</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">jiffy_nums</span><span class="p">)),</span> <span class="s2">&quot;Error: RChirpVoice rows&#39; jiffy_nums must be unique&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_find_closest_row_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_row</span><span class="p">()</span><span class="o">.</span><span class="n">row_num</span>

    <span class="k">def</span> <span class="nf">get_filled_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">rn</span><span class="p">]</span><span class="o">.</span><span class="n">row_num</span> <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="s2">&quot;No row 0 in rows&quot;</span>  <span class="c1"># Row 0 should exist!</span>
        <span class="n">last_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">current_instrument</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Because max_row needs to be included!</span>
            <span class="k">if</span> <span class="n">rn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">last_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">rn</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">last_row</span><span class="o">.</span><span class="n">new_instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">current_instrument</span> <span class="o">=</span> <span class="n">last_row</span><span class="o">.</span><span class="n">new_instrument</span>
                <span class="k">if</span> <span class="n">last_row</span><span class="o">.</span><span class="n">note_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">last_row</span><span class="o">.</span><span class="n">instr_num</span> <span class="o">=</span> <span class="n">current_instrument</span>
                <span class="n">ret_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_row</span> <span class="o">=</span> <span class="n">RChirpRow</span><span class="p">()</span>
                <span class="n">tmp_row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">=</span> <span class="n">rn</span>
                <span class="n">tmp_row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">=</span> <span class="n">last_row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">+</span> <span class="n">last_row</span><span class="o">.</span><span class="n">jiffy_len</span>
                <span class="n">tmp_row</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">=</span> <span class="n">last_row</span><span class="o">.</span><span class="n">jiffy_len</span>
                <span class="n">last_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tmp_row</span><span class="p">)</span>
                <span class="n">ret_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret_rows</span>

    <span class="k">def</span> <span class="nf">_fixup_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Goes through the rows and adds missing elements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">row_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Row number is None!&quot;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="c1"># Make sure the row has a row_num</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">row_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">=</span> <span class="n">r</span>
            <span class="c1"># Jiffy number is derived from the last row</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">+</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">-</span> <span class="n">last</span><span class="o">.</span><span class="n">row_num</span><span class="p">)</span> <span class="o">*</span> <span class="n">last</span><span class="o">.</span><span class="n">jiffy_len</span>
            <span class="c1"># If no jiffy length, use the one from the last row</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">jiffy_len</span>
            <span class="c1"># If the row is a note off, set the note number</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">note_num</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">note_num</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">orderlist_to_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_jiffy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">irow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderlist</span><span class="p">:</span>
            <span class="n">patt</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">pattern_num</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">transposition</span>
            <span class="k">if</span> <span class="n">patt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">patterns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ChiptuneSAKContentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Illegal pattern number: </span><span class="si">{</span><span class="n">patt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">repeats</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">patt</span><span class="p">]</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="n">tmp_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">tmp_row</span><span class="o">.</span><span class="n">row_num</span> <span class="o">=</span> <span class="n">current_row</span>
                    <span class="n">tmp_row</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">=</span> <span class="n">current_jiffy</span>
                    <span class="k">if</span> <span class="n">tmp_row</span><span class="o">.</span><span class="n">note_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tmp_row</span><span class="o">.</span><span class="n">note_num</span> <span class="o">+=</span> <span class="n">trans</span>
                    <span class="n">current_row</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">current_jiffy</span> <span class="o">+=</span> <span class="n">tmp_row</span><span class="o">.</span><span class="n">jiffy_len</span>
                    <span class="n">ret_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_row</span><span class="p">)</span>
                    <span class="n">irow</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ret_rows</span>

    <span class="k">def</span> <span class="nf">validate_orderlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filled_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filled_rows</span><span class="p">()</span>
        <span class="n">compressed_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderlist_to_rows</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filled_rows</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed_rows</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">c_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compressed_rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c_row</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filled_rows</span><span class="p">[</span><span class="n">irow</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;row mismatch in voice </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at row </span><span class="si">{</span><span class="n">irow</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  compressed: </span><span class="si">{</span><span class="n">c_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  original:   </span><span class="si">{</span><span class="n">filled_rows</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="RChirpVoice.import_chirp_track"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpVoice.import_chirp_track">[docs]</a>    <span class="k">def</span> <span class="nf">import_chirp_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chirp_track</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Imports a Chirp track into a raw RChirpVoice object.  No compression or conversion to patterns</span>
<span class="sd">           and orderlists performed.  Track must be non-polyphonic and quantized.</span>
<span class="sd">        </span>
<span class="sd">        :param chirp_track: A chirp track</span>
<span class="sd">        :type chirp_track: ctsChirp.ChirpTrack</span>
<span class="sd">        :raises ChiptuneSAKQuantizationError: Thrown if chirp track is not quantized</span>
<span class="sd">        :raises ChiptuneSAKPolyphonyError: Thrown if a single voice contains polyphony</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChiptuneSAKQuantizationError</span><span class="p">(</span><span class="s2">&quot;Track must be quantized to generate RChirp.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">is_polyphonic</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChiptuneSAKPolyphonyError</span><span class="p">(</span><span class="s2">&quot;Track must be non-polyphonic to generate RChirp.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Right now don&#39;t allow tempo variations; just use the initial tempo</span>
        <span class="n">ticks_per_jiffy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">qpm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">update_freq</span><span class="p">)</span>
        <span class="n">jiffies_per_row</span> <span class="o">=</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">qticks_notes</span> <span class="o">//</span> <span class="n">ticks_per_jiffy</span>
        <span class="n">ticks_per_row</span> <span class="o">=</span> <span class="n">ticks_per_jiffy</span> <span class="o">*</span> <span class="n">jiffies_per_row</span>
        <span class="n">rows_per_quarter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span> <span class="o">/</span> <span class="n">ticks_per_row</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">jiffies_per_quarter</span> <span class="o">=</span> <span class="n">rows_per_quarter</span> <span class="o">*</span> <span class="n">jiffies_per_row</span>
        <span class="n">jiffies_per_row</span> <span class="o">=</span> <span class="n">jiffies_per_quarter</span> <span class="o">*</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">qticks_notes</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">rchirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span>
        <span class="n">ticks_per_row</span> <span class="o">=</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">qticks_notes</span>
        <span class="n">tmp_rows</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">RChirpRow</span><span class="p">)</span>

        <span class="c1"># Always insert a row number 0</span>
        <span class="n">tmp_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RChirpRow</span><span class="p">(</span><span class="n">row_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">jiffy_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">jiffy_len</span><span class="o">=</span><span class="n">jiffies_per_row</span><span class="p">,</span>
                                <span class="n">new_jiffy_tempo</span><span class="o">=</span><span class="n">jiffies_per_row</span><span class="p">)</span>
        <span class="c1"># Insert the notes into the voice</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">chirp_track</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
            <span class="n">n_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">start_time</span> <span class="o">//</span> <span class="n">ticks_per_row</span><span class="p">)</span>  <span class="c1"># Note: if tempo varies this gets complicated.</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">row_num</span> <span class="o">=</span> <span class="n">n_row</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="o">=</span> <span class="n">n_row</span> <span class="o">*</span> <span class="n">jiffies_per_row</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">note_num</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">note_num</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">=</span> <span class="n">jiffies_per_row</span>
            <span class="n">e_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">n</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">//</span> <span class="n">ticks_per_row</span><span class="p">)</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">e_row</span><span class="p">]</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Program changes will only occur on rows tat already have note content.  SO no new rows will be created.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chirp_track</span><span class="o">.</span><span class="n">program_changes</span><span class="p">):</span>
            <span class="n">n_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_closest_row_after</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">start_time</span> <span class="o">/</span> <span class="n">ticks_per_row</span><span class="p">)</span>
            <span class="n">new_instrument</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">program</span> <span class="o">%</span> <span class="mi">13</span><span class="p">)</span>
            <span class="n">tmp_rows</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span><span class="o">.</span><span class="n">new_instrument</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_instrument</span><span class="p">)</span>  <span class="c1"># TODO: Map midi instruments into tracker instruments</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">tmp_rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixup_rows</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RChirpSong"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong">[docs]</a><span class="k">class</span> <span class="nc">RChirpSong</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The representation of an RChirp song.  Contains voices, voice groups, and metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chirp_song</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_freq</span> <span class="o">=</span> <span class="n">ARCH</span><span class="p">[</span><span class="s1">&#39;NTSC-C64&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">frame_rate</span>  <span class="c1">#: Update frequency expressed as frame rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voices</span> <span class="o">=</span> <span class="p">[]</span>                                <span class="c1">#: List of RChirpVoice instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice_groups</span> <span class="o">=</span> <span class="p">[]</span>                          <span class="c1">#: Voice groupings for lowering to multiple chips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>                              <span class="c1">#: Patterns to be shared among the voices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>                                 <span class="c1">#: TODO: ???</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>                            <span class="c1">#: Song metadata (author, copyright, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="kc">None</span>                               <span class="c1">#: Other meta-events in song</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compressed</span> <span class="o">=</span> <span class="kc">False</span>                         <span class="c1">#: Has song been through compression algorithm?</span>

        <span class="k">if</span> <span class="n">chirp_song</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">SongMetadata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">chirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">chirp_song</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="s2">&quot;&lt;class &#39;ctsChirp.ChirpSong&#39;&gt;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChiptuneSAKTypeError</span><span class="p">(</span><span class="s2">&quot;MChirpSong init can only import ChirpSong objects&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_chirp_song</span><span class="p">(</span><span class="n">chirp_song</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">voice_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of voices (channels)</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">)</span>

<div class="viewcode-block" id="RChirpSong.import_chirp_song"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong.import_chirp_song">[docs]</a>    <span class="k">def</span> <span class="nf">import_chirp_song</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chirp_song</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Imports a ChirpSong</span>
<span class="sd">        </span>
<span class="sd">        :param chirp_song: A chirp song</span>
<span class="sd">        :type chirp_song: ctsChirp.ChirpSong</span>
<span class="sd">        :raises ChiptuneSAKQuantizationError: Thrown if chirp track is not quantized</span>
<span class="sd">        :raises ChiptuneSAKPolyphonyError: Thrown if a single voice contains polyphony</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chirp_song</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChiptuneSAKQuantizationError</span><span class="p">(</span><span class="s2">&quot;ChirpSong must be quantized to create RChirp.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chirp_song</span><span class="o">.</span><span class="n">is_polyphonic</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChiptuneSAKPolyphonyError</span><span class="p">(</span><span class="s2">&quot;ChirpSong must not be polyphonic to create RChirp.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chirp_song</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RChirpVoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">chirp_song</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">chirp_song</span><span class="o">.</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compressed</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RChirpSong.is_contiguous"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong.is_contiguous">[docs]</a>    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the voices&#39; rows are contiguous, without gaps in time</span>
<span class="sd">        </span>
<span class="sd">        :return: True if rows are contiguous, False if not</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">voice</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="k">for</span> <span class="n">voice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">)</span></div>

<div class="viewcode-block" id="RChirpSong.integrity_check"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong.integrity_check">[docs]</a>    <span class="k">def</span> <span class="nf">integrity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds problems with voices&#39; row data</span>

<span class="sd">        :return: True if integrity checks pass for all voices</span>
<span class="sd">        :raises AssertionError: Various integrity failure assertions possible</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">voice</span><span class="o">.</span><span class="n">integrity_check</span><span class="p">()</span> <span class="k">for</span> <span class="n">voice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jiffy_indexed_voices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of lists, where many voices hold onto many rows.  Rows indexed by jiffy number.</span>
<span class="sd">        </span>
<span class="sd">        :return: a list of lists (voices-&gt;rows)</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">voice</span><span class="o">.</span><span class="n">jiffy_indexed_rows</span> <span class="k">for</span> <span class="n">voice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">validate_orderlist</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">)</span>

    <span class="c1"># Create CVS debug output</span>
<div class="viewcode-block" id="RChirpSong.note_time_data_str"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong.note_time_data_str">[docs]</a>    <span class="k">def</span> <span class="nf">note_time_data_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a comma-separated value list representation of the rchirp data</span>
<span class="sd">        </span>
<span class="sd">        :return: CSV string</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_str_with_null_handling</span><span class="p">(</span><span class="n">a_value</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">a_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">a_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">max_tick</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_last_row</span><span class="p">()</span><span class="o">.</span><span class="n">jiffy_num</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">))</span>

        <span class="n">channels_time_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jiffy_indexed_voices</span>

        <span class="n">csv_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;jiffy&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">):</span>
            <span class="n">csv_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;v</span><span class="si">%d</span><span class="s2"> row #&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">csv_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;v</span><span class="si">%d</span><span class="s2"> note&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">csv_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;v</span><span class="si">%d</span><span class="s2"> on/off/none&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">csv_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;v</span><span class="si">%d</span><span class="s2"> tempo update&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
 
        <span class="n">csv_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_tempo</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span>
        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tick</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># if any channel has a entry at this tick, create a row for all channels</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tick</span> <span class="ow">in</span> <span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">)):</span>
                <span class="n">a_csv_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tick</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">event</span> <span class="o">=</span> <span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">row_num</span><span class="p">)</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_str_with_null_handling</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">note_num</span><span class="p">))</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_str_with_null_handling</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">gate</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">jiffy_len</span> <span class="o">!=</span> <span class="n">prev_tempo</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">tempo_update</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">jiffy_len</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tempo_update</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">tempo_update</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">a_csv_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">csv_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a_csv_row</span><span class="p">))</span>
        <span class="n">spreadsheet</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csv_rows</span><span class="p">)</span>
        <span class="n">spreadsheet</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csv_header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">spreadsheet</span>
   
        <span class="k">return</span> <span class="n">spreadsheet</span></div>

<div class="viewcode-block" id="RChirpSong.convert_to_chirp"><a class="viewcode-back" href="../Classes.html#ctsRChirp.RChirpSong.convert_to_chirp">[docs]</a>    <span class="k">def</span> <span class="nf">convert_to_chirp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">song_name</span><span class="o">=</span><span class="s1">&#39;TODO: GET FROM METADATA INSTEAD&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert rchirp song to chirp</span>
<span class="sd">        </span>
<span class="sd">        :param song_name: Name of song.  TODO: Get this from metadata instead below?</span>
<span class="sd">        :type song_name: str, optional</span>
<span class="sd">        :return: chirp conversion</span>
<span class="sd">        :rtype: ChirpSong</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">song</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">ChirpSong</span><span class="p">()</span>
        <span class="n">song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span> <span class="o">=</span> <span class="n">DEFAULT_MIDI_PPQN</span>
        <span class="n">song</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">song_name</span>

        <span class="n">channels_time_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jiffy_indexed_voices</span><span class="p">()</span>
        <span class="n">all_ticks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">note_ticks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_ticks</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> 
                        <span class="ow">and</span> <span class="p">(</span><span class="n">channels_time_events</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voice_count</span><span class="p">))])</span>
        <span class="n">notes_offset</span> <span class="o">=</span> <span class="n">note_ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># TODO: Should the two &quot;100&quot;s be parameterized?</span>
        <span class="n">ticks_per_note</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">,</span> <span class="p">(</span><span class="n">note_ticks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">notes_offset</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">ticks_per_note</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># no decent gcd for this data</span>
            <span class="n">ticks_per_note</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">notes_per_minute</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">ticks_per_note</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">notes_per_minute</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">tempo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">notes_per_minute</span> <span class="o">//</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">tick_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">song</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ppq</span> <span class="o">//</span> <span class="n">tempo</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span>

        <span class="n">midi_tick</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">channel_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels_time_events</span><span class="p">):</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">ChirpTrack</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
            <span class="n">track</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Track </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">it</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">track</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">it</span>
            <span class="n">current_note</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">channel_data</span><span class="p">):</span>
                <span class="n">midi_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">tick</span> <span class="o">-</span> <span class="n">notes_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">tick_factor</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">channel_data</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">gate</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_note</span><span class="p">:</span>
                        <span class="n">new_note</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span>
                            <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">current_note</span><span class="o">.</span><span class="n">note_num</span><span class="p">,</span> <span class="n">midi_tick</span> <span class="o">-</span> <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_note</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">track</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_note</span><span class="p">)</span>
                    <span class="n">current_note</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span><span class="n">midi_tick</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">note_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_note</span><span class="p">:</span>
                        <span class="n">new_note</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span>
                            <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">current_note</span><span class="o">.</span><span class="n">note_num</span><span class="p">,</span> <span class="n">midi_tick</span> <span class="o">-</span> <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_note</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">track</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_note</span><span class="p">)</span>
                    <span class="n">current_note</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">current_note</span><span class="p">:</span>
                <span class="n">new_note</span> <span class="o">=</span> <span class="n">ctsChirp</span><span class="o">.</span><span class="n">Note</span><span class="p">(</span>
                    <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">current_note</span><span class="o">.</span><span class="n">note_num</span><span class="p">,</span> <span class="n">midi_tick</span> <span class="o">-</span> <span class="n">current_note</span><span class="o">.</span><span class="n">start_time</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">new_note</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">track</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_note</span><span class="p">)</span>
            <span class="n">song</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">song</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ChiptuneSAK</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MusicConcepts.html">Musical Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html">Chirp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html#chirp-formats">Chirp Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chirp.html#concepts-in-chirp-music-representation">Concepts in chirp music representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sheetmusic.html">PDF Sheetmusic via Lilypond</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c128BASIC.html">C128 BASIC music programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Classes.html">Classes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, David Youd and David Knapp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>